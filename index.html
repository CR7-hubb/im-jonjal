<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ë²½ëŒê¹¨ê¸° 4.0 â€” Ultimate</title>
<style>
  :root {
    --bg:#0b0b0f;
    --panel:#111;
    --text:#fff;
  }
  body {
    margin:0;
    font-family: "Inter", "Segoe UI", Arial, sans-serif;
    background: radial-gradient(circle at top left, #071029, #000);
    color:var(--text);
    display:flex;
    gap:12px;
    align-items:flex-start;
    padding:12px;
    box-sizing:border-box;
  }
  .left {
    flex:0 0 520px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  canvas { background:#101218; border-radius:10px; display:block; margin:auto; border:4px solid #222; }
  .controls {
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:center;
  }
  .panel {
    background:rgba(0,0,0,0.25);
    border-radius:8px;
    padding:8px;
    display:flex;
    gap:8px;
    align-items:center;
  }
  select, button {
    background:#222; color:#fff; border:1px solid #333; padding:6px 8px; border-radius:6px;
  }
  .right {
    flex:0 0 320px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .stat, .log {
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    padding:10px; border-radius:8px; min-height:80px;
  }
  .big {
    font-size:18px; font-weight:600;
  }
  .small { font-size:13px; color:#bbb; }
  .btn {
    cursor:pointer;
  }
  .flexrow { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  @media (max-width:900px){
    body{flex-direction:column; align-items:center;}
    .left, .right { width:100%; flex:unset; }
  }
</style>
</head>
<body>
  <div class="left">
    <div class="panel controls">
      <label>í…Œë§ˆ:
        <select id="themeSelect">
          <option value="neon">ë„¤ì˜¨</option>
          <option value="sunset">ì„ ì…‹</option>
          <option value="ocean">ì˜¤ì…˜</option>
        </select>
      </label>

      <label>ë‚œì´ë„:
        <select id="difficulty">
          <option value="easy">Easy</option>
          <option value="normal" selected>Normal</option>
          <option value="hard">Hard</option>
        </select>
      </label>

      <button id="soundToggle" class="btn">ğŸ”Š Sound: ON</button>
      <button id="saveBtn" class="btn">ğŸ’¾ ì €ì¥</button>
      <button id="loadBtn" class="btn">â¤´ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button id="restartBtn" class="btn">âŸ² ìƒˆ ê²Œì„</button>
    </div>

    <canvas id="gameCanvas" width="640" height="420"></canvas>

    <div class="panel flexrow" style="justify-content:space-between;">
      <div class="small">í„°ì¹˜: ìº”ë²„ìŠ¤ í„°ì¹˜/ë“œë˜ê·¸ë¡œ íŒ¨ë“¤ ì´ë™</div>
      <div class="small">í‚¤: â† â†’</div>
    </div>
  </div>

  <div class="right">
    <div class="stat">
      <div class="big">ìƒíƒœ</div>
      <div id="stats" class="small">
        Score: 0 Â· Best: 0 Â· Level: 1 Â· Lives: 3<br/>
        Balls: 1 Â· Multiball: off<br/>
        Theme: neon Â· Difficulty: normal
      </div>
    </div>

    <div class="stat">
      <div class="big">ì•„ì´í…œ & ì„¤ëª…</div>
      <div class="small">
        - Expand: íŒ¨ë“¤ì´ ì¼ì‹œì ìœ¼ë¡œ ê¸¸ì–´ì§„ë‹¤.<br/>
        - Slow: ê³µ ì†ë„ê°€ ì¼ì‹œì ìœ¼ë¡œ ëŠë ¤ì§„ë‹¤.<br/>
        - Multiball: ê³µ 3ê°œë¡œ ëŠ˜ì–´ë‚¨.<br/>
        - Shield: ë°”ë‹¥ì— ë³´í˜¸ë§‰ì´ ìƒê²¨ í•œ ë²ˆ ê³µì„ ë§‰ì•„ì¤Œ.
      </div>
    </div>

    <div class="log" id="log">
      <div class="big">ë¡œê·¸</div>
      <div id="logLines" class="small"></div>
    </div>
  </div>

<script>
/* ========== ì„¤ì •ê°’ ========== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const themeSelect = document.getElementById('themeSelect');
const difficultySel = document.getElementById('difficulty');
const soundToggleBtn = document.getElementById('soundToggle');
const saveBtn = document.getElementById('saveBtn');
const loadBtn = document.getElementById('loadBtn');
const restartBtn = document.getElementById('restartBtn');

const statsDiv = document.getElementById('stats');
const logLines = document.getElementById('logLines');

const WIDTH = canvas.width, HEIGHT = canvas.height;

/* í…Œë§ˆ íŒ”ë ˆíŠ¸ */
const THEMES = {
  neon: ['#00fff7','#ff00d0','#ffea00','#00ff70'],
  sunset: ['#ff6b6b','#ffa94d','#ffd43b','#ffd8a8'],
  ocean: ['#2dd4bf','#4f46e5','#60a5fa','#0ea5a8']
};

/* ì˜¤ë””ì˜¤ (ì‘ì§€ë§Œ ì•ˆì •ì ì¸ ì†Œë¦¬ URL ì‚¬ìš© â€” ë¸Œë¼ìš°ì € ì •ì±… ì£¼ì˜) */
let soundOn = true;
const SFX = {
  brick: new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg'),
  item: new Audio('https://actions.google.com/sounds/v1/cartoon/metal_twang.ogg'),
  level: new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg'),
  gameover: new Audio('https://actions.google.com/sounds/v1/cartoon/concussive_hit_guitar_boing.ogg'),
};
/* ìë™ì¬ìƒ ì •ì±… â€” ì‚¬ìš©ìê°€ ìƒí˜¸ì‘ìš©í•  ë•Œê¹Œì§€ ì¬ìƒ ì‹œë„í•˜ì§€ ì•ŠìŒ */
function playSfx(sfx){
  if(!soundOn) return;
  try{ sfx.currentTime=0; sfx.play().catch(()=>{}); }catch(e){}
}

/* ë‚œì´ë„ ì˜í–¥ê°’ */
const DIFFICULTY = {
  easy:   { baseSpeed: 2.2, lives: 5 },
  normal: { baseSpeed: 3.2, lives: 3 },
  hard:   { baseSpeed: 4.2, lives: 2 }
};

/* ========== ê²Œì„ ìƒíƒœ ========== */
let theme = 'neon';
let palette = THEMES[theme];
let difficulty = 'normal';

let score = 0;
let bestScore = parseInt(localStorage.getItem('bestScore')||0,10);
let level = 1;
let lives = DIFFICULTY[difficulty].lives;
let balls = []; // ë‹¤ì¤‘ ê³µì„ ìœ„í•œ ë°°ì—´
let paddle = { width: 100, height: 12, x: (WIDTH-100)/2, speed: 7 };
let bricks = []; // 2D ë°°ì—´
let items = []; // ë‚™í•˜ ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸
let shield = false; // ë°”ë‹¥ ë³´í˜¸ë§‰
let gameRunning = true;
let logBuffer = [];
let multiballActive = false;
let paused = false;

/* ë²½ëŒ ì„¤ì • (ë ˆë²¨ì— ë”°ë¼ row/col ì¡°ì ˆ ê°€ëŠ¥) */
const BRICK = { rows:4, cols:8, w:60, h:20, padding:10, offsetTop:40, offsetLeft:30 };

/* ì•„ì´í…œ ì¢…ë¥˜ì™€ ì§€ì†ì‹œê°„(ë°€ë¦¬ì´ˆ) */
const ITEM_TYPES = {
  expand: {dur:7000},
  slow: {dur:5000},
  multiball: {dur:0},
  shield: {dur:8000},
};

/* ì•ˆì „: ì•„ì´í…œ ì¤‘ë³µ ì²˜ë¦¬ ë ˆì½”ë“œ (íƒ€ì…ë³„ cooldown) */
let itemCooldown = {};

/* ========== ìœ í‹¸ë¦¬í‹° ========== */
function log(msg){
  const time = new Date().toLocaleTimeString();
  logBuffer.unshift(`[${time}] ${msg}`);
  logBuffer = logBuffer.slice(0,30);
  logLines.innerHTML = logBuffer.join('<br/>');
}
function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

/* ========== ì´ˆê¸°í™” í•¨ìˆ˜ë“¤ ========== */
function resetGame(opts = { keepBest:false }) {
  difficulty = difficultySel.value;
  palette = THEMES[themeSelect.value] || THEMES.neon;
  theme = themeSelect.value;
  score = 0;
  level = 1;
  lives = DIFFICULTY[difficulty].lives;
  paddle.width = 100;
  paddle.x = (WIDTH - paddle.width) / 2;
  items = [];
  itemCooldown = {};
  multiballActive = false;
  shield = false;
  balls = [];
  initBall(); // ê¸°ë³¸ 1ê°œ
  initBricks();
  gameRunning = true;
  saveProgress(); // ì´ˆê¸° ì €ì¥
  refreshStats();
  log('ê²Œì„ì„ ìƒˆë¡œ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.');
}

/* ê³µ ìƒì„± (vector ê¸°ë°˜) */
function createBall(xpos=null, ypos=null, speedMultiplier=1, angleDeg = null){
  const spd = DIFFICULTY[difficulty].baseSpeed * speedMultiplier;
  const x0 = xpos ?? (WIDTH/2);
  const y0 = ypos ?? (HEIGHT-60);
  // angle: -60 ~ -120 deg (upwards)
  const angle = (angleDeg!==null) ? angleDeg * Math.PI/180 : ( -80 + (Math.random()*40 -20) ) * Math.PI/180;
  const dx = spd * Math.cos(angle);
  const dy = spd * Math.sin(angle);
  return { x: x0, y: y0, r:8, dx, dy, stuck:false, id:Date.now()+Math.random() };
}

function initBall(){
  balls = [ createBall() ];
}

/* ë²½ëŒ ì´ˆê¸°í™”: type/ì²´ë ¥ ì§€ì •. ë³´ìŠ¤ ë ˆë²¨(ì˜ˆ: 5ì˜ ë°°ìˆ˜)ì—” ë³´ìŠ¤ ë“±ì¥ */
function initBricks(){
  bricks = [];
  const rows = BRICK.rows + Math.floor((level-1)/2); // ë ˆë²¨ ì˜¤ë¥´ë©´ í–‰ ì¦ê°€
  const cols = BRICK.cols;
  for(let c=0;c<cols;c++){
    bricks[c]=[];
    for(let r=0;r<rows;r++){
      // íƒ€ì… ê²°ì •
      let type='normal', hp=1;
      const rng = Math.random();
      if(level % 5 === 0 && r===0 && c===Math.floor(cols/2)){ // ë³´ìŠ¤ ë§¨ ìœ„ ì¤‘ì•™ í‘œì‹œ
        type='boss'; hp = 12 + level*2;
      } else if(rng < 0.06) { type='bomb'; hp=1; }
      else if(rng < 0.28) { type='hard'; hp = 2 + Math.floor(level/3); }
      else type='normal';
      bricks[c][r] = { x:0, y:0, w:BRICK.w, h:BRICK.h, status:1, type, hp };
    }
  }
  BRICK.rows = rows;
}

/* ========== ì•„ì´í…œ ìŠ¤í°/íš¨ê³¼ ========== */
function spawnItem(x,y){
  // ì œí•œ: ë™ì¼ íƒ€ì… ì—°ì† ìŠ¤í° ë°©ì§€ (ê°„ë‹¨í•œ ì¿¨ë‹¤ìš´)
  const types = ['expand','slow','multiball','shield'];
  const type = types[Math.floor(Math.random()*types.length)];
  if(itemCooldown[type] && Date.now() - itemCooldown[type] < 2000) return; // 2ì´ˆ ì´ë‚´ ì¬ìŠ¤í° ë°©ì§€
  const it = { x, y, r:7, type, vy:1.5, active:true, created:Date.now() };
  items.push(it);
  itemCooldown[type] = Date.now();
  log(`ì•„ì´í…œ ì¶œí˜„: ${type}`);
}

/* ì•„ì´í…œ ì ìš© â€” ì¤‘ë³µ/ì¤‘ì²© ì•ˆì „í•˜ê²Œ */
const activeItemTimers = {};
function applyItem(it){
  if(!it || !it.type) return;
  const type = it.type;
  playSfx(SFX.item);
  if(type==='expand'){
    if(activeItemTimers.expand) clearTimeout(activeItemTimers.expand);
    paddle.width = Math.min(180, paddle.width + 50);
    activeItemTimers.expand = setTimeout(()=>{ paddle.width = 100; delete activeItemTimers.expand; }, ITEM_TYPES.expand.dur);
    log('íŒ¨ë“¤ì´ í™•ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } else if(type==='slow'){
    if(activeItemTimers.slow) clearTimeout(activeItemTimers.slow);
    // ëª¨ë“  ê³µ ëŠë ¤ì§€ê¸° (ë¹„ìœ¨ ì¡°ì ˆ)
    balls.forEach(b=>{
      b.dx *= 0.6; b.dy *= 0.6;
    });
    activeItemTimers.slow = setTimeout(()=>{
      // ë³µêµ¬: ëª¨ë“  ê³µì„ ë‚œì´ë„ ê¸°ë°˜ ê¸°ë³¸ê°’ìœ¼ë¡œ ì¬ì •ë ¬(ë‹¨ìˆœí™”)
      balls.forEach(b=>{
        const signX = Math.sign(b.dx) || 1;
        const signY = Math.sign(b.dy) || -1;
        const base = DIFFICULTY[difficulty].baseSpeed;
        b.dx = signX * (Math.abs(b.dx) < base ? base : Math.abs(b.dx));
        b.dy = signY * (Math.abs(b.dy) < base ? base : Math.abs(b.dy));
      });
      delete activeItemTimers.slow;
    }, ITEM_TYPES.slow.dur);
    log('ê³µ ì†ë„ê°€ ëŠë ¤ì¡ŒìŠµë‹ˆë‹¤.');
  } else if(type==='multiball'){
    if(multiballActive) { log('ì´ë¯¸ Multiball í™œì„±í™” ì¤‘.'); return; }
    multiballActive = true;
    // ê¸°ì¡´ ê³µì„ ì¤‘ì‹¬ìœ¼ë¡œ 2ê°œ ë” ìƒì„±
    const base = balls[0] || createBall();
    const b1 = createBall(base.x, base.y, 1, -60);
    const b2 = createBall(base.x, base.y, 1, -100);
    balls.push(b1,b2);
    // 12ì´ˆ í›„ ì‚¬ë¼ì§€ê²Œ(ì¶”ê°€ ê³µì„ ì œê±°)
    setTimeout(()=>{
      // ë³´ì¡´: ì ì–´ë„ 1ê°œë§Œ ë‚¨ê¸°ê¸°
      if(balls.length>1){
        balls = [ balls[0] ];
      }
      multiballActive = false;
      log('Multiball ì¢…ë£Œ.');
    }, 12000);
    log('Multiball ë°œë™! ê³µì´ 3ê°œê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } else if(type==='shield'){
    shield = true;
    if(activeItemTimers.shield) clearTimeout(activeItemTimers.shield);
    activeItemTimers.shield = setTimeout(()=>{ shield=false; delete activeItemTimers.shield; }, ITEM_TYPES.shield.dur);
    log('ë°”ë‹¥ ë³´í˜¸ë§‰ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
}

/* ========== ì¶©ëŒ ë° ë¬¼ë¦¬ ========== */

/* ê³µ-ë²½ëŒ ì¶©ëŒ ì²˜ë¦¬ */
function handleBallBrickCollision(ball){
  for(let c=0;c<bricks.length;c++){
    for(let r=0;r<bricks[c].length;r++){
      const b = bricks[c][r];
      if(!b || !b.status) continue;
      // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
      if(ball.x > b.x && ball.x < b.x + b.w && ball.y > b.y && ball.y < b.y + b.h){
        // ë‹¨ìˆœ ë°˜ì‚¬: ë°˜ì‚¬ ë°©í–¥ì„ ë” ìì—°ìŠ¤ëŸ½ê²Œ í•˜ë ¤ë©´ ì ‘ì´‰ ìœ„ì¹˜ ê¸°ë°˜ìœ¼ë¡œ ë¶„í•´ ê°€ëŠ¥
        // ì—¬ê¸°ì„œëŠ” yë°©í–¥ì„ ë°˜ì „ì‹œí‚¤ë˜, xê³„ìˆ˜ë„ ì†ŒëŸ‰ ë³€í™”
        ball.dy = -ball.dy;
        // ì‘ì€ ëœë¤ íŠ€ê¹€ ë³´ì •ìœ¼ë¡œ ê³µì´ ì§ì„ ìœ¼ë¡œ ê°€ëŠ”ê±¸ ë°©ì§€
        ball.dx += (Math.random()-0.5)*0.6;
        b.hp--;
        playSfx(SFX.brick);
        if(b.hp <= 0){
          b.status = 0;
          // ì ìˆ˜: ë³´ìŠ¤/í•˜ë“œ/ì¼ë°˜ ê°€ì¤‘ì¹˜
          if(b.type==='boss') score += 200;
          else if(b.type==='hard') score += 40;
          else if(b.type==='bomb') score += 60;
          else score += 10;
          // í­ë°œ ì²˜ë¦¬
          if(b.type === 'bomb') explodeAround(c,r);
          // ì•„ì´í…œ ë“œë¡­ í™•ë¥  (10%)
          if(Math.random() < 0.12) spawnItem(b.x + b.w/2, b.y + b.h/2);
        } else {
          // ë§ì•˜ì§€ë§Œ íŒŒê´´ ì•ˆë¨: ì•½ê°„ì˜ ì ìˆ˜
          score += 5;
        }
        // ìµœê³ ì  ê°±ì‹ 
        if(score > bestScore) { bestScore = score; localStorage.setItem('bestScore', bestScore); }
        return; // í•œ ê³µì´ í•œ í”„ë ˆì„ì— ì—¬ëŸ¬ ë²½ëŒì„ íŒŒê´´í•˜ëŠ” ê²ƒì„ ë°©ì§€
      }
    }
  }
}

/* í­ë°œ: ì£¼ë³€ 3x3 ì œê±° (ì¸ë±ìŠ¤ ì•ˆì „ í™•ì¸) */
function explodeAround(cIdx, rIdx){
  for(let dc=-1;dc<=1;dc++){
    for(let dr=-1;dr<=1;dr++){
      const nc = cIdx+dc, nr = rIdx+dr;
      if(bricks[nc] && bricks[nc][nr] && bricks[nc][nr].status){
        bricks[nc][nr].status = 0;
      }
    }
  }
  log('í­ë°œ ë²½ëŒ ì‘ë™!');
}

/* ê³µ-íŒ¨ë“¤ ì¶©ëŒ: ë°˜ì‚¬ê° ê³„ì‚° (íŒ¨ë“¤ ì¤‘ì•™ ê¸°ì¤€) */
function handleBallPaddleCollision(ball){
  const paddleTop = HEIGHT - paddle.height - 10;
  if(ball.y + ball.r >= paddleTop && ball.y - ball.r <= paddleTop + paddle.height){
    if(ball.x > paddle.x && ball.x < paddle.x + paddle.width){
      // hitPoint: -1(left) .. 0(center) .. +1(right)
      const hitPoint = (ball.x - (paddle.x + paddle.width/2)) / (paddle.width/2);
      const maxBounce = Math.PI * 3/4; // 135 deg cone
      const angle = hitPoint * maxBounce/2; // reduce angle range
      const speed = Math.max( DIFFICULTY[difficulty].baseSpeed, Math.hypot(ball.dx,ball.dy) );
      ball.dx = speed * Math.sin(angle);
      ball.dy = -Math.abs(speed * Math.cos(angle));
      // ì†Œì†Œí•œ ë³´ì •
      ball.y = paddleTop - ball.r - 0.5;
      playSfx(SFX.brick);
      return true;
    }
  }
  return false;
}

/* ê²½ê³„ ì²˜ë¦¬: ë²½/ë°”ë‹¥ ì¶©ëŒ */
function handleWallCollisions(ball){
  if(ball.x - ball.r <= 0){
    ball.x = ball.r+0.5;
    ball.dx = Math.abs(ball.dx);
  } else if(ball.x + ball.r >= WIDTH){
    ball.x = WIDTH - ball.r - 0.5;
    ball.dx = -Math.abs(ball.dx);
  }
  if(ball.y - ball.r <= 0){
    ball.y = ball.r + 0.5;
    ball.dy = Math.abs(ball.dy);
  } else if(ball.y - ball.r > HEIGHT + 20){
    // ë°”ë‹¥ ì•„ë˜ë¡œ ì™„ì „íˆ ë¹ ì§ -> ê³µ ì œê±° or ë¼ì´í”„ ê°ì†Œ
    return 'out';
  }
  return 'ok';
}

/* ========== ë Œë”ë§ ========== */
function draw(){
  ctx.clearRect(0,0,WIDTH,HEIGHT);
  // ë°°ê²½ ê·¸ë¼ë””ì–¸íŠ¸ subtle
  const g = ctx.createLinearGradient(0,0,0,HEIGHT);
  g.addColorStop(0, 'rgba(255,255,255,0.02)');
  g.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,WIDTH,HEIGHT);

  // ë²½ëŒ
  for(let c=0;c<bricks.length;c++){
    for(let r=0;r<bricks[c].length;r++){
      const b = bricks[c][r];
      if(!b || !b.status) continue;
      const bx = BRICK.offsetLeft + c*(b.w + BRICK.padding);
      const by = BRICK.offsetTop + r*(b.h + BRICK.padding);
      b.x = bx; b.y = by;
      // ìƒ‰ìƒ ê²°ì •
      let color = palette[(r+c) % palette.length];
      if(b.type==='hard') color = shadeColor(color, -25);
      if(b.type==='bomb') color = '#ff3b3b';
      if(b.type==='boss') color = '#ffd166';
      ctx.fillStyle = color;
      ctx.fillRect(bx,by,b.w,b.h);
      // ì²´ë ¥ í‘œì‹œ (ì‘ê²Œ)
      if(b.hp > 1){
        ctx.fillStyle = 'rgba(0,0,0,0.5)';
        ctx.font = '12px monospace';
        ctx.fillText(b.hp, bx + b.w - 18, by + b.h - 4);
      }
      // í…Œë‘ë¦¬
      ctx.strokeStyle = 'rgba(0,0,0,0.3)';
      ctx.strokeRect(bx,by,b.w,b.h);
    }
  }

  // ì•„ì´í…œ
  items.forEach(it=>{
    if(!it.active) return;
    ctx.beginPath();
    ctx.arc(it.x, it.y, it.r, 0, Math.PI*2);
    const col = itemColor(it.type);
    ctx.fillStyle = col;
    ctx.fill();
    ctx.closePath();
  });

  // íŒ¨ë“¤
  ctx.fillStyle = shadeColor(palette[1], -10);
  ctx.fillRect(paddle.x, HEIGHT - paddle.height - 10, paddle.width, paddle.height);
  ctx.strokeStyle = 'rgba(0,0,0,0.4)';
  ctx.strokeRect(paddle.x, HEIGHT - paddle.height - 10, paddle.width, paddle.height);

  // ë³´í˜¸ë§‰
  if(shield){
    ctx.beginPath();
    ctx.arc(WIDTH/2, HEIGHT-6, 60, Math.PI, 2*Math.PI);
    ctx.fillStyle = 'rgba(80,160,255,0.12)';
    ctx.fill();
  }

  // ê³µ
  balls.forEach(b=>{
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
    ctx.fillStyle = '#ffdd57';
    ctx.fill();
    ctx.closePath();
  });

  // UI í…ìŠ¤íŠ¸
  ctx.fillStyle = '#fff';
  ctx.font = '14px Inter, Arial';
  ctx.fillText(`Score: ${score}`, 10, 20);
  ctx.fillText(`Best: ${bestScore}`, 110, 20);
  ctx.fillText(`Level: ${level}`, 200, 20);
  ctx.fillText(`Lives: ${lives}`, 300, 20);
  ctx.fillText(`Balls: ${balls.length}`, 380, 20);
}

/* ìƒ‰ìƒ ë³´ì • helper */
function shadeColor(hex, percent) {
  // hex like #rrggbb
  const f=parseInt(hex.slice(1),16),t=percent<0?0:255,p=Math.abs(percent)/100,
    R=f>>16,G=f>>8&0x00FF,B=f&0x0000FF;
  const newR = Math.round((t-R)*p)+R;
  const newG = Math.round((t-G)*p)+G;
  const newB = Math.round((t-B)*p)+B;
  return '#' + (0x1000000 + (newR<<16) + (newG<<8) + newB).toString(16).slice(1);
}
function itemColor(type){
  if(type==='expand') return '#00f6ff';
  if(type==='slow') return '#ff5a5a';
  if(type==='multiball') return '#ffd166';
  if(type==='shield') return '#a0e9ff';
  return '#fff';
}

/* ========== ê²Œì„ ë£¨í”„ ========== */
let lastTime = performance.now();
function step(now){
  if(!gameRunning) return;
  const dt = now - lastTime;
  lastTime = now;

  // ë¬¼ë¦¬ ì—…ë°ì´íŠ¸(í”„ë ˆì„ ë…ë¦½ì  ê°„ë‹¨ êµ¬í˜„)
  // ê³µ ì—…ë°ì´íŠ¸
  for(let i = balls.length-1; i>=0; i--){
    const b = balls[i];
    b.x += b.dx;
    b.y += b.dy;

    // ë²½ ì¶©ëŒ
    const wallState = handleWallCollisions(b);
    if(wallState === 'out'){
      // ë°”ë‹¥ ì•„ë˜ë¡œ ë¹ ì§ ì²˜ë¦¬
      if(shield){
        // ë³´í˜¸ë§‰ì´ ìˆìœ¼ë©´ íŒŒê´´ ëŒ€ì‹  ë³´í˜¸ë§‰ ì œê±°
        shield = false;
        playSfx(SFX.brick);
        balls.splice(i,1); // ê³µ í•˜ë‚˜ ì‚¬ë¼ì§ (ì‹œê°ì )
        if(balls.length===0) initBall();
        continue;
      } else {
        // ê³µ ì œê±°: ë¼ì´í”„ ì°¨ê°ì€ ëª¨ë“  ê³µì´ ë°”ë‹¥ ë¹ ì§ˆ ë•Œë§Œ
        balls.splice(i,1);
        if(balls.length===0){
          lives--;
          playSfx(SFX.gameover);
          if(lives <= 0){
            gameOver();
            return;
          } else {
            // ê³µ ë¦¬ì…‹
            setTimeout(()=>{ initBall(); }, 400);
            log('ê³µì„ ìƒì—ˆìŠµë‹ˆë‹¤. ë‚¨ì€ ëª©ìˆ¨: ' + lives);
            break;
          }
        } else continue;
      }
    }

    // íŒ¨ë“¤ ì¶©ëŒ
    handleBallPaddleCollision(b);

    // ë²½ëŒ ì¶©ëŒ
    handleBallBrickCollision(b);
  }

  // ì•„ì´í…œ ë‚™í•˜ ë° ì¶©ëŒ
  items.forEach(it=>{
    if(!it.active) return;
    it.y += it.vy;
    // ìº”ë²„ìŠ¤ ë°–ì´ë©´ ì œê±°
    if(it.y > HEIGHT + 30){ it.active = false; return; }
    // íŒ¨ë“¤ê³¼ ì¶©ëŒ
    if(it.y > HEIGHT - paddle.height - 20 && it.x > paddle.x && it.x < paddle.x + paddle.width){
      applyItem(it);
      it.active = false;
    }
  });
  // ì •ë¦¬
  items = items.filter(it=>it.active);

  // ë³´ìŠ¤ ë ˆë²¨ í´ë¦¬ì–´ ì²´í¬: ëª¨ë“  ë²½ëŒ íŒŒê´´ ì‹œ ë‹¤ìŒ ë ˆë²¨
  if(checkClear()){
    levelUp();
  }

  draw();
  refreshStats();

  // ë‹¤ìŒ í”„ë ˆì„
  requestAnimationFrame(step);
}
function checkClear(){
  for(let c=0;c<bricks.length;c++){
    for(let r=0;r<bricks[c].length;r++){
      if(bricks[c][r] && bricks[c][r].status) return false;
    }
  }
  return true;
}
function levelUp(){
  playSfx(SFX.level);
  log(`ë ˆë²¨ ${level} í´ë¦¬ì–´! ë‹¤ìŒ ë ˆë²¨ë¡œ ì´ë™.`);
  level++;
  // ë‚œì´ë„ë³„ ì†ë„ ë° í–‰ ì¡°ì •ì€ initBricksì—ì„œ ë°˜ì˜
  // ì•½ê°„ì˜ ë³´ìƒ: ëª©ìˆ¨ 1ê°œ íšŒë³µ (ìµœëŒ€ ì´ˆê¸°ê°’)
  lives = Math.min( DIFFICULTY[difficulty].lives, lives + 1 );
  // ëœ í˜¼ë€ìŠ¤ëŸ½ê²Œ í•˜ê¸° ìœ„í•´ ì•„ì´í…œ & ê³µ ì´ˆê¸°í™”
  items = [];
  itemCooldown = {};
  activeItemTimers.expand && clearTimeout(activeItemTimers.expand);
  activeItemTimers.slow && clearTimeout(activeItemTimers.slow);
  multiballActive = false;
  shield = false;
  // ê³µ ì´ˆê¸°í™”: í•˜ë‚˜ë¡œ
  initBall();
  initBricks();
  saveProgress();
  // ì•½ê°„ì˜ ë©”ì‹œì§€
  setTimeout(()=>{ alert(`ğŸ‰ ë ˆë²¨ ${level} ì‹œì‘!`); }, 50);
}

/* ê²Œì„ ì˜¤ë²„ ì²˜ë¦¬ */
function gameOver(){
  gameRunning = false;
  playSfx(SFX.gameover);
  log('ê²Œì„ ì˜¤ë²„');
  // ì €ì¥: ìµœê³ ì ì€ ì´ë¯¸ ì—…ë°ì´íŠ¸ë¨
  setTimeout(()=>{ alert('ê²Œì„ ì˜¤ë²„! ì ìˆ˜: ' + score); location.reload(); }, 60);
}

/* ========== ì…ë ¥ ì²˜ë¦¬ ========== */
let leftPressed=false, rightPressed=false;
document.addEventListener('keydown', (e)=>{
  if(e.key === 'ArrowLeft') leftPressed = true;
  if(e.key === 'ArrowRight') rightPressed = true;
  if(e.key === 'p') { paused = !paused; if(paused){ gameRunning=false; } else { gameRunning=true; lastTime = performance.now(); requestAnimationFrame(step); } }
});
document.addEventListener('keyup', (e)=>{
  if(e.key === 'ArrowLeft') leftPressed = false;
  if(e.key === 'ArrowRight') rightPressed = false;
});
canvas.addEventListener('touchstart', e=>{
  const tx = e.touches[0].clientX - canvas.getBoundingClientRect().left;
  paddle.x = clamp(tx - paddle.width/2, 0, WIDTH - paddle.width);
});
canvas.addEventListener('touchmove', e=>{
  const tx = e.touches[0].clientX - canvas.getBoundingClientRect().left;
  paddle.x = clamp(tx - paddle.width/2, 0, WIDTH - paddle.width);
  e.preventDefault();
});

/* ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ë„ í—ˆìš© */
let dragging=false;
canvas.addEventListener('mousedown', e=>{
  dragging=true;
  const mx = e.clientX - canvas.getBoundingClientRect().left;
  paddle.x = clamp(mx - paddle.width/2, 0, WIDTH - paddle.width);
});
window.addEventListener('mouseup', ()=> dragging=false);
window.addEventListener('mousemove', e=>{
  if(!dragging) return;
  const mx = e.clientX - canvas.getBoundingClientRect().left;
  paddle.x = clamp(mx - paddle.width/2, 0, WIDTH - paddle.width);
});

/* í”„ë ˆì„ ë§ˆë‹¤ íŒ¨ë“¤ ì´ë™ */
setInterval(()=> {
  if(!gameRunning) return;
  if(leftPressed) paddle.x = Math.max(0, paddle.x - paddle.speed);
  if(rightPressed) paddle.x = Math.min(WIDTH - paddle.width, paddle.x + paddle.speed);
}, 16);

/* ========== ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ========== */
function saveProgress(){
  const data = {
    score, bestScore, level, lives, difficulty, theme,
    paddleWidth: paddle.width,
  };
  localStorage.setItem('breakout4_save', JSON.stringify(data));
  log('ì§„í–‰ìƒíƒœ ì €ì¥ë¨.');
}
function loadProgress(){
  const raw = localStorage.getItem('breakout4_save');
  if(!raw) { log('ì €ì¥ëœ ì§„í–‰ìƒíƒœê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  try{
    const d = JSON.parse(raw);
    score = d.score || 0;
    bestScore = d.bestScore || bestScore;
    level = d.level || 1;
    lives = d.lives || DIFFICULTY[d.difficulty||'normal'].lives;
    difficulty = d.difficulty || difficulty;
    theme = d.theme || theme;
    themeSelect.value = theme;
    difficultySel.value = difficulty;
    paddle.width = d.paddleWidth || 100;
    initBricks();
    initBall();
    log('ì§„í–‰ìƒíƒœ ë¶ˆëŸ¬ì˜´.');
  }catch(e){ log('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + e.message); }
}

/* ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²° */
soundToggleBtn.addEventListener('click', ()=>{
  soundOn = !soundOn;
  soundToggleBtn.textContent = soundOn ? 'ğŸ”Š Sound: ON' : 'ğŸ”ˆ Sound: OFF';
  log('ì‚¬ìš´ë“œ ' + (soundOn ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'));
});
saveBtn.addEventListener('click', saveProgress);
loadBtn.addEventListener('click', loadProgress);
restartBtn.addEventListener('click', ()=>{ if(confirm('ìƒˆ ê²Œì„ì„ ì‹œì‘í• ê¹Œìš”? í˜„ì¬ ì§„í–‰ì€ ì €ì¥ë©ë‹ˆë‹¤.')) { saveProgress(); resetGame(); } });

/* ë‚œì´ë„/í…Œë§ˆ ë³€ê²½ ì‹œ ê°„ë‹¨í•œ ì¦‰ì‹œ ë°˜ì˜ */
difficultySel.addEventListener('change', ()=>{ difficulty = difficultySel.value; lives = DIFFICULTY[difficulty].lives; saveProgress(); refreshStats(); log('ë‚œì´ë„ ë³€ê²½: ' + difficulty); });
themeSelect.addEventListener('change', ()=>{ theme = themeSelect.value; palette = THEMES[theme]; refreshStats(); log('í…Œë§ˆ ë³€ê²½: ' + theme); });

/* ========== í—¬í¼ ë° ì‹œì‘ ========== */
function refreshStats(){
  statsDiv.innerHTML = `Score: ${score} Â· Best: ${bestScore} Â· Level: ${level} Â· Lives: ${lives}<br/>
  Balls: ${balls.length} Â· Multiball: ${multiballActive? 'on':'off'}<br/>
  Theme: ${theme} Â· Difficulty: ${difficulty}`;
}

/* ì´ˆê¹ƒê°’ ì ìš© */
resetGame();

/* ë Œë” ë£¨í”„ ì‹œì‘ */
requestAnimationFrame(step);

/* ========== ì¶”ê°€ ë³´ì™„: ì£¼ê¸°ì  ì ìˆ˜ ì €ì¥ ========== */
setInterval(()=>{ if(gameRunning) saveProgress(); }, 15000);

/* ========== ë ========== */
</script>
</body>
</html>
