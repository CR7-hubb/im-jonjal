<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ğŸ”¥ ìŠˆí¼ê°“ RPG v6 ğŸ”¥</title>
<style>
html, body {margin:0; overflow:hidden; background:#000;}
canvas {display:block; margin:auto; border:3px solid #fff; background:#1b5e20;}
#ui {position:absolute; top:10px; left:10px; color:white; font-family:"Press Start 2P", monospace; font-size:12px; text-shadow:1px 1px 2px black;}
#inventory {position:absolute; top:50px; right:20px; width:220px; background:rgba(0,0,0,0.7); color:white; border:2px solid #fff; padding:10px; font-family:"Press Start 2P", monospace; font-size:10px; display:none;}
#msgBox {position:absolute; bottom:20px; left:50%; transform:translateX(-50%); width:80%; background:rgba(0,0,0,0.6); color:white; font-family:"Press Start 2P", monospace; font-size:11px; padding:15px; border:2px solid white; border-radius:10px; display:none;}
</style>
</head>
<body>
<canvas id="gameCanvas" width="960" height="640"></canvas>
<div id="ui">â¤ï¸ HP: <span id="hp">100</span> | ğŸ”¥ MP: <span id="mp">50</span> | ğŸ’° Gold: <span id="gold">0</span> | ğŸ’ [I] ì¸ë²¤í† ë¦¬</div>
<div id="inventory"></div>
<div id="msgBox"></div>

<audio id="bgm" src="https://cdn.pixabay.com/download/audio/2023/07/05/audio_6782827f58.mp3?filename=retro-rpg-bgm.mp3" loop autoplay></audio>
<audio id="hitSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_1ea2c7a3d2.mp3?filename=hit-sword-2.mp3"></audio>
<audio id="potionSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_3a4f1f2e34.mp3?filename=potion-drink.mp3"></audio>
<audio id="effectSound" src="https://cdn.pixabay.com/download/audio/2023/03/12/audio_03f60e2a4c.mp3?filename=magic-effect.mp3"></audio>
<audio id="skillSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_9c2e7f7b8c.mp3?filename=magic-spell.mp3"></audio>

<script>
// ===========================
// ê¸°ë³¸ ì„¤ì •
// ===========================
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const hpUI = document.getElementById("hp");
const mpUI = document.getElementById("mp");
const goldUI = document.getElementById("gold");
const inventoryUI = document.getElementById("inventory");
const msgBox = document.getElementById("msgBox");
const bgm = document.getElementById("bgm");
const hitSound = document.getElementById("hitSound");
const potionSound = document.getElementById("potionSound");
const effectSound = document.getElementById("effectSound");
const skillSound = document.getElementById("skillSound");
document.body.addEventListener("click",()=>{bgm.play().catch(()=>{});},{once:true});

// ===========================
// ìƒìˆ˜
// ===========================
const TILE_SIZE=32;
const MAP_W=60;
const MAP_H=40;

// ===========================
// ë§µ ìƒì„±
// ===========================
const map=[];
for(let y=0;y<MAP_H;y++){
  const row=[];
  for(let x=0;x<MAP_W;x++){
    let t=0;
    if(Math.random()<0.05) t=1;
    if(Math.random()<0.02) t=2;
    if(x==0||y==0||x==MAP_W-1||y==MAP_H-1) t=2;
    row.push(t);
  }
  map.push(row);
}
const tileColors=["#1b5e20","#33691e","#4e342e"];

// ===========================
// í”Œë ˆì´ì–´
// ===========================
const player={
  x:5,y:5,hp:100,mp:50,gold:0,speed:2,sprite:new Image(),anim:0,dir:0,
  inventory:[],equipment:{weapon:null,armor:null},isUsingItem:false,alive:true,
  skillCooldown:0
};
player.sprite.src="https://i.ibb.co/L9G8Fg8/hero-spritesheet.png";

// ===========================
// í‚¤ ì…ë ¥
// ===========================
const keys={};
window.addEventListener("keydown",e=>keys[e.key]=true);
window.addEventListener("keyup",e=>keys[e.key]=false);

// ===========================
// NPC
// ===========================
const npcs=[
  {x:10,y:8,msg:"ì•ˆë…•, ì—¬í–‰ì!",itemGiven:false},
  {x:15,y:14,msg:"Eí‚¤ë¡œ ëŒ€í™”, Ií‚¤ë¡œ ì¸ë²¤í† ë¦¬ ì—´ê¸°",itemGiven:false},
  {x:22,y:12,msg:"í¬ì…˜ì„ ì¤„ê²Œ!",itemGiven:false}
];

// ===========================
// ëª¬ìŠ¤í„°
// ===========================
const monsters=[];
for(let i=0;i<20;i++){
  monsters.push({
    x:Math.floor(Math.random()*MAP_W),
    y:Math.floor(Math.random()*MAP_H),
    hp:30,atk:5,rewardGold:10,anim:0
  });
}

// ===========================
// ë³´ìŠ¤
// ===========================
const boss = {x:MAP_W-5, y:MAP_H-5, hp:200, atk:15, alive:true, anim:0, skillTimer:0};

// ===========================
// ì•„ì´í…œ
// ===========================
const itemList=[
  {name:"í¬ì…˜",type:"use",effect:()=>{
    if(!player.isUsingItem && player.alive){
      player.isUsingItem=true;
      potionSound.play();
      showMsg("HP +30 íšŒë³µ!");
      player.hp=Math.min(100,player.hp+30);
      setTimeout(()=>{player.isUsingItem=false},500);
    }
  }},
  {name:"ë‹¨ê²€",type:"weapon",atk:5},
  {name:"ê°•ì² ê°‘ì˜·",type:"armor",def:3},
  {name:"ê¸ˆí™”ì£¼ë¨¸ë‹ˆ",type:"gold",amount:50}
];

// ===========================
// í•¨ìˆ˜
// ===========================
function canMove(nx,ny){return player.alive && map[Math.floor(ny)] && map[Math.floor(ny)][Math.floor(nx)]!==2;}

function updatePlayer(){
  if(!player.alive) return;
  let moved=false;
  const speed=player.speed;
  if(keys["ArrowUp"] && canMove(player.x,player.y-speed/32)){player.y-=speed/32; player.dir=3; moved=true;}
  if(keys["ArrowDown"] && canMove(player.x,player.y+speed/32)){player.y+=speed/32; player.dir=0; moved=true;}
  if(keys["ArrowLeft"] && canMove(player.x-speed/32,player.y)){player.x-=speed/32; player.dir=1; moved=true;}
  if(keys["ArrowRight"] && canMove(player.x+speed/32,player.y)){player.x+=speed/32; player.dir=2; moved=true;}
  if(moved) player.anim+=0.15;
  if(player.skillCooldown>0) player.skillCooldown-=0.016; // ì•½ 60FPS ê¸°ì¤€
}

// ===========================
// ëª¬ìŠ¤í„° AI
// ===========================
function updateMonsters(){
  for(let m of monsters){
    if(m.hp<=0) continue;
    const dx=player.x-m.x;
    const dy=player.y-m.y;
    if(Math.abs(dx)<0.8 && Math.abs(dy)<0.8){
      // ê·¼ì ‘ ê³µê²©
      player.hp -= m.atk - (player.equipment.armor?player.equipment.armor.def:0);
      if(player.hp<0) player.hp=0;
      effectSound.play();
      showMsg("ëª¬ìŠ¤í„° ê³µê²©!");
    } else {
      // ë‹¨ìˆœ ì¶”ì 
      if(Math.abs(dx)>0.1) m.x += dx>0?0.02:-0.02;
      if(Math.abs(dy)>0.1) m.y += dy>0?0.02:-0.02;
    }
  }
}

// ===========================
// ë³´ìŠ¤ AI
// ===========================
function updateBoss(){
  if(!boss.alive) return;
  const dx = player.x - boss.x;
  const dy = player.y - boss.y;
  boss.skillTimer+=0.016;
  if(boss.skillTimer>3){ // 3ì´ˆë§ˆë‹¤ ìŠ¤í‚¬
    boss.skillTimer=0;
    player.hp -= boss.atk*1.5 - (player.equipment.armor?player.equipment.armor.def:0);
    effectSound.play();
    showMsg("ğŸ’¥ ë³´ìŠ¤ ìŠ¤í‚¬ ê³µê²©!");
  }
  if(Math.abs(dx)>0.1) boss.x += dx>0?0.01:-0.01;
  if(Math.abs(dy)>0.1) boss.y += dy>0?0.01:-0.01;
}

// ===========================
// UI
// ===========================
function drawMap(){
  const startX=Math.floor(player.x-15);
  const startY=Math.floor(player.y-10);
  for(let y=0;y<20;y++){
    for(let x=0;x<30;x++){
      const mx=startX+x;
      const my=startY+y;
      if(map[my] && map[my][mx]!==undefined){
        ctx.fillStyle=tileColors[map[my][mx]];
        ctx.fillRect(x*TILE_SIZE,y*TILE_SIZE,TILE_SIZE,TILE_SIZE);
      }
    }
  }
}

function drawNPCs(){ctx.fillStyle="yellow"; for(let npc of npcs){const dx=npc.x-player.x;const dy=npc.y-player.y;if(Math.abs(dx)<15 && Math.abs(dy)<10){ctx.fillRect((dx+15)*TILE_SIZE,(dy+10)*TILE_SIZE,TILE_SIZE,TILE_SIZE);}}}
function drawMonsters(){ctx.fillStyle="red"; for(let m of monsters){const dx=m.x-player.x;const dy=m.y-player.y;if(Math.abs(dx)<15 && Math.abs(dy)<10){ctx.fillRect((dx+15)*TILE_SIZE,(dy+10)*TILE_SIZE,TILE_SIZE,TILE_SIZE);}}}
function drawBoss(){if(boss.alive){ctx.fillStyle="purple";const dx=boss.x-player.x;const dy=boss.y-player.y;if(Math.abs(dx)<15 && Math.abs(dy)<10){ctx.fillRect((dx+15)*TILE_SIZE,(dy+10)*TILE_SIZE,TILE_SIZE,TILE_SIZE);}}}
function drawPlayer(){const frame=Math.floor(player.anim)%3;ctx.drawImage(player.sprite,frame*32,player.dir*32,32,32,canvas.width/2-TILE_SIZE/2,canvas.height/2-TILE_SIZE/2,TILE_SIZE,TILE_SIZE);}
function showMsg(txt){msgBox.textContent=txt; msgBox.style.display="block"; setTimeout(()=>msgBox.style.display="none",1000);}
function openInventory(){inventoryUI.style.display=inventoryUI.style.display==="block"?"none":"block"; if(inventoryUI.style.display==="block"){let html="<b>ğŸ’ ì¸ë²¤í† ë¦¬</b><hr>"; player.inventory.forEach((item,i)=>{html+=`${i+1}. ${item.name}<br>`;}); html+="<hr><small>[Enter]ë¡œ ì‚¬ìš©</small>"; inventoryUI.innerHTML=html;}}

// ===========================
// ì „íˆ¬ ë° ìŠ¤í‚¬
// ===========================
let combatCooldown=false;
function checkCombat(){
  if(!player.alive) return;
  for(let m of monsters){
    if(m.hp<=0) continue;
    if(Math.abs(player.x-m.x)<0.8 && Math.abs(player.y-m.y)<0.8 && !combatCooldown){
      combatCooldown=true;
      m.hp -=10 + (player.equipment.weapon?player.equipment.weapon.atk:0);
      effectSound.play();
      showMsg("ëª¬ìŠ¤í„° ê³µê²©!");
      setTimeout(()=>{combatCooldown=false;},300);
      if(m.hp<=0){player.gold+=m.rewardGold; showMsg(`ëª¬ìŠ¤í„° ì²˜ì¹˜! ğŸ’°${m.rewardGold} íšë“`); m.x=-100;m.y=-100;}
    }
  }
  if(boss.alive && Math.abs(player.x-boss.x)<1 && Math.abs(player.y-boss.y)<1 && !combatCooldown){
    combatCooldown=true;
    boss.hp -=15 + (player.equipment.weapon?player.equipment.weapon.atk:0);
    effectSound.play();
    showMsg("ë³´ìŠ¤ ê³µê²©!");
    setTimeout(()=>{combatCooldown=false;},500);
    if(boss.hp<=0){boss.alive=false; showMsg("ğŸ‰ ë³´ìŠ¤ ê²©íŒŒ! ìŠ¹ë¦¬!"); player.gold+=200;}
  }
}

// ===========================
// NPC ëŒ€í™”
// ===========================
function checkNPC(){for(let npc of npcs){const dist=Math.abs(player.x-npc.x)+Math.abs(player.y-npc.y);if(dist<1.2 && keys["e"] && !npc.itemGiven){showMsg(npc.msg); npc.itemGiven=true; if(npc.msg.includes("í¬ì…˜")) giveItem(itemList[0]);}}}
function giveItem(it){player.inventory.push(it); showMsg(`${it.name} íšë“!`); openInventory();}

// ===========================
// ì‚¬ë§ ì²˜ë¦¬
// ===========================
function checkPlayerDeath(){if(player.hp<=0 && player.alive){player.hp=0; player.alive=false; showMsg("ğŸ’€ ê²Œì„ ì˜¤ë²„"); player.speed=0; keys.ArrowUp=keys.ArrowDown=keys.ArrowLeft=keys.ArrowRight=false; setTimeout(()=>location.reload(),3000);}}

// ===========================
// ë£¨í”„
// ===========================
function loop(){ctx.clearRect(0,0,canvas.width,canvas.height); drawMap(); drawNPCs(); drawMonsters(); drawBoss(); updatePlayer(); drawPlayer(); checkNPC(); checkCombat(); checkPlayerDeath(); updateMonsters(); updateBoss(); hpUI.textContent=player.hp; mpUI.textContent=Math.floor(player.mp); goldUI.textContent=player.gold; requestAnimationFrame(loop);}
loop();

// ===========================
// í‚¤ ì´ë²¤íŠ¸
// ===========================
window.addEventListener("keydown",e=>{
  if(e.key.toLowerCase()==="i") openInventory();
  if(e.key==="Enter" && inventoryUI.style.display==="block" && player.alive){
    if(player.inventory.length>0){
      const it=player.inventory.shift();
      if(it.type==="use") it.effect();
      else if(it.type==="weapon") player.equipment.weapon=it;
      else if(it.type==="armor") player.equipment.armor=it;
      openInventory();
    }
  }
  // ìŠ¤í‚¬ Q ì‚¬ìš©
  if(e.key.toLowerCase()==="q" && player.skillCooldown<=0 && player.alive && player.mp>=10){
    skillSound.play();
    showMsg("ğŸ”¥ í™”ì—¼ ìŠ¤í‚¬ ì‚¬ìš©!");
    player.mp-=10;
    player.skillCooldown=3;
    for(let m of monsters){if(Math.abs(player.x-m.x)<3 && Math.abs(player.y-m.y)<3){m.hp-=20;}}
    if(boss.alive && Math.abs(player.x-boss.x)<3 && Math.abs(player.y-boss.y)<3){boss.hp-=30;}
  }
  // íšŒë³µ ìŠ¤í‚¬ W
  if(e.key.toLowerCase()==="w" && player.skillCooldown<=0 && player.alive && player.mp>=15){
    skillSound.play();
    showMsg("ğŸ’– íšŒë³µ ì£¼ë¬¸!");
    player.mp-=15;
    player.skillCooldown=5;
    player.hp=Math.min(100,player.hp+40);
  }
});
</script>
</body>
</html>
