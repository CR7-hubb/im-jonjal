<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>🔥 슈퍼갓 RPG v1.0 🔥</title>
<style>
html, body {
  margin: 0;
  overflow: hidden;
  background: #000;
}
canvas {
  display: block;
  margin: auto;
  background: #111;
  border: 3px solid #fff;
}
#ui {
  position: absolute;
  top: 10px; left: 10px;
  color: white;
  font-family: "Press Start 2P", monospace;
  font-size: 12px;
  text-shadow: 1px 1px 2px black;
}
#msgBox {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  width: 80%;
  background: rgba(0,0,0,0.6);
  color: white;
  font-family: "Press Start 2P", monospace;
  font-size: 11px;
  padding: 15px;
  border: 2px solid white;
  border-radius: 10px;
  display: none;
}
</style>
</head>
<body>
<canvas id="gameCanvas" width="960" height="640"></canvas>
<div id="ui">❤️ HP: <span id="hp">100</span> | 💰 Gold: <span id="gold">0</span></div>
<div id="msgBox">대화 내용...</div>

<audio id="bgm" src="https://cdn.pixabay.com/download/audio/2023/03/13/audio_7cfcd3272f.mp3?filename=8-bit-music-142342.mp3" loop autoplay></audio>

<script>
// =========================
// 전역 설정
// =========================
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const uiHp = document.getElementById("hp");
const uiGold = document.getElementById("gold");
const msgBox = document.getElementById("msgBox");
const bgm = document.getElementById("bgm");

// BGM 자동 재생 보장
document.body.addEventListener("click", () => {
  bgm.play().catch(()=>{});
}, { once:true });

// =========================
// 기본 데이터
// =========================
const TILE_SIZE = 32;
const MAP_WIDTH = 30;
const MAP_HEIGHT = 20;

// 간단한 타일맵 (0=바닥,1=벽)
const map = [];
for (let y=0; y<MAP_HEIGHT; y++) {
  const row = [];
  for (let x=0; x<MAP_WIDTH; x++) {
    row.push((x==0||y==0||x==MAP_WIDTH-1||y==MAP_HEIGHT-1)?1:0);
  }
  map.push(row);
}

// =========================
// 플레이어 설정
// =========================
const player = {
  x: 5, y: 5,
  hp: 100,
  gold: 0,
  sprite: new Image(),
  speed: 0.15,
  anim: 0
};
player.sprite.src = "https://i.ibb.co/b5sSnQz/hero.png";

const keys = {};
window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

// =========================
// NPC 설정
// =========================
const npcs = [
  {x:10, y:8, msg:"안녕? 나는 이 마을의 안내자야."},
  {x:15, y:12, msg:"조심해! 숲에 몬스터가 숨어있대."}
];

// =========================
// 그리기 함수
// =========================
function drawMap() {
  for (let y=0; y<MAP_HEIGHT; y++) {
    for (let x=0; x<MAP_WIDTH; x++) {
      if (map[y][x] === 1) {
        ctx.fillStyle = "#333";
      } else {
        ctx.fillStyle = "#1b5e20";
      }
      ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
    }
  }
}

function drawPlayer() {
  ctx.drawImage(player.sprite,
    Math.floor(player.anim)%3*32, 0, 32, 32,
    player.x*TILE_SIZE, player.y*TILE_SIZE, TILE_SIZE, TILE_SIZE
  );
}

function drawNPCs() {
  ctx.fillStyle = "yellow";
  for (let npc of npcs) {
    ctx.fillRect(npc.x*TILE_SIZE, npc.y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
  }
}

// =========================
// 이동 및 충돌
// =========================
function canMove(nx, ny) {
  return map[Math.floor(ny)] && map[Math.floor(ny)][Math.floor(nx)] === 0;
}

function updatePlayer(dt) {
  let moved = false;
  if (keys["ArrowUp"] && canMove(player.x, player.y - player.speed*dt)) {player.y -= player.speed*dt; moved=true;}
  if (keys["ArrowDown"] && canMove(player.x, player.y + player.speed*dt)) {player.y += player.speed*dt; moved=true;}
  if (keys["ArrowLeft"] && canMove(player.x - player.speed*dt, player.y)) {player.x -= player.speed*dt; moved=true;}
  if (keys["ArrowRight"] && canMove(player.x + player.speed*dt, player.y)) {player.x += player.speed*dt; moved=true;}
  if (moved) player.anim += 0.2;
}

// =========================
// NPC 대화
// =========================
function checkNPCInteraction() {
  for (let npc of npcs) {
    const dist = Math.abs(player.x - npc.x) + Math.abs(player.y - npc.y);
    if (dist < 1) {
      msgBox.style.display = "block";
      msgBox.textContent = npc.msg;
      return;
    }
  }
  msgBox.style.display = "none";
}

// =========================
// 게임 루프
// =========================
let last = 0;
function gameLoop(ts) {
  const dt = ts - last;
  last = ts;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawMap();
  drawNPCs();
  updatePlayer(dt);
  drawPlayer();
  checkNPCInteraction();
  uiHp.textContent = player.hp;
  uiGold.textContent = player.gold;
  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>
